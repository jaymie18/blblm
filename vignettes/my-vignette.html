<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Jaymie Tam" />


<title>Bag of Little Bootstrap</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Bag of Little Bootstrap</h1>
<h4 class="author">Jaymie Tam</h4>



<h3>
Introduction
</h3>
<p><br> This project is to create, modify and improve the bag of little bootstrap R packages. The R package is called the blblm and it is designed primarily for use by individuals who are interested in data analysis to help them perform a weighted bootstrap linear regression. Additionally, this package provides a list of other functions to estimates based on the linear regression. This package is useful for data which may not meet the assumption of parametric linear regression such as small sample sizes, asymmetric statistical distribution. Since some students may only want to have preliminary understanding of the data, this r package may help them to achieve their result.</p>
<p>**The restriction of the function does not omit na datas, to further usage of the package, please use na.omit(data) before using the function.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(blblm)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(bench)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(mtcars)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">df &lt;-<span class="st"> </span><span class="kw">na.omit</span>(mtcars)</a></code></pre></div>
<h3>
Features
</h3>
<p><br> <strong>Bootstrap Linear Regression(blblm)</strong><br> <br> Based on the user’s interest in data, the function performs bootstrap linear regression by splitting data into subsamples and sample n from b with replacement which is different from ordinary bootstrap. <br> <br> Coefficient of the desired explanatory/independent variable<br></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">#arr_delay time against Sepal</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#m = 3 subsamples</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#B = 100 bootstraps</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">model &lt;-<span class="st"> </span><span class="kw">blblm</span>(mpg <span class="op">~</span><span class="st"> </span>wt <span class="op">*</span><span class="st"> </span>hp, <span class="dt">data =</span> df, <span class="dt">m =</span> <span class="dv">3</span>, <span class="dt">B =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">coef</span>(model)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt;  (Intercept)           wt           hp        wt:hp </span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt;  53.31555111 -10.26989006  -0.13539179   0.03766053</span></a></code></pre></div>
<p>-Formula of the regression model<br></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">formula</span>(model)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; mpg ~ wt * hp</span></a></code></pre></div>
<p>Estimates of each bootstrap coefficient result</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">#first and second output of the estimates from bootstrap</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">model<span class="op">$</span>estimates<span class="op">$</span><span class="st">`</span><span class="dt">1</span><span class="st">`</span>[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; $coef</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; (Intercept)          wt          hp       wt:hp </span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; 46.70381840 -7.61398059 -0.12771960  0.03059246 </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt; $sigma</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; [1] 1.406263</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">model<span class="op">$</span>estimates<span class="op">$</span><span class="st">`</span><span class="dt">1</span><span class="st">`</span>[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; $coef</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; (Intercept)          wt          hp       wt:hp </span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt; 48.21478940 -8.42585866 -0.12879388  0.03269145 </span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt; $sigma</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt; [1] 1.150173</span></a></code></pre></div>
<p><strong>Bootstrap Linear Regression with Parallelization</strong><br> It performs the same result as the Bootstrap Linear Regression(blblm), and it adds a feature of parallelization to speed up for larger dataset.<br></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#cl = cluster user uses</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">model2 &lt;-<span class="st"> </span><span class="kw">blblm_par</span>(mpg <span class="op">~</span><span class="st"> </span>wt <span class="op">*</span><span class="st"> </span>hp, <span class="dt">data =</span> mtcars, <span class="dt">m =</span> <span class="dv">3</span>, <span class="dt">B =</span> <span class="dv">100</span>, cl)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="kw">stopCluster</span>(cl)</a></code></pre></div>
<p>Formula of the regression model<br></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">model2<span class="op">$</span>formula</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; mpg ~ wt * hp</span></a></code></pre></div>
<p>Coefficient of the desired explanatory/independent variable<br></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">coef</span>(model2)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; (Intercept)          wt          hp       wt:hp </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; 47.28306583 -7.96380668 -0.07943302  0.01872409</span></a></code></pre></div>
<p>Estimates of each bootstrap coefficient result</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">#first output of the estimates from bootstrap</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">model2<span class="op">$</span>estimates<span class="op">$</span><span class="st">`</span><span class="dt">1</span><span class="st">`</span>[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt; $coef</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt;  (Intercept)           wt           hp        wt:hp </span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt;  68.31006889 -13.51969161  -0.21433303   0.05559039 </span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt; $sigma</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt; [1] 1.140657</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">model2<span class="op">$</span>estimates<span class="op">$</span><span class="st">`</span><span class="dt">1</span><span class="st">`</span>[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#&gt; $coef</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt; (Intercept)          wt          hp       wt:hp </span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt; 49.25239637 -7.62394874 -0.11048023  0.02412177 </span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#&gt; $sigma</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt; [1] 2.19165</span></a></code></pre></div>
<p><br> <strong>Confidence Interval(confint)</strong><br> Confidence Interval for explanatory variables in a user’s desired confidence level.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">confint</span>(model, <span class="dt">level =</span> <span class="fl">0.95</span>)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt;               2.5%       97.5%</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; wt    -14.09697192 -7.30560264</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; hp     -0.26057122 -0.06813659</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; wt:hp   0.01961522  0.07344827</span></a></code></pre></div>
<p><strong>Predict New Data</strong><br> It allows user to predict new data based on the linear regression model</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">pred &lt;-<span class="st"> </span><span class="kw">predict</span>(model, <span class="kw">data.frame</span>(<span class="dt">wt =</span> <span class="kw">c</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>)), <span class="dt">hp =</span> <span class="kw">c</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>))))</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">head</span>(pred)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#&gt;        1        2        3        4        5        6 </span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; 62.98724 67.31572 47.48078 59.60136 47.04635 50.30622</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#user can choose to include condifence level</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">pred2 &lt;-<span class="st"> </span><span class="kw">predict</span>(model, <span class="kw">data.frame</span>(<span class="dt">wt =</span> <span class="kw">c</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>)), <span class="dt">hp =</span> <span class="kw">c</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>))), <span class="dt">confidence =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="kw">head</span>(pred2)</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">#&gt;        fit      lwr      upr</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt; 1 47.12206 39.90619 57.27615</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt; 2 66.46358 53.93733 83.76681</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#&gt; 3 56.89697 47.04055 70.69180</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#&gt; 4 42.73171 36.65362 51.13838</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#&gt; 5 57.27512 47.31717 71.22360</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#&gt; 6 66.64879 54.09337 83.91908</span></a></code></pre></div>
<p><strong>Sigma with confidence level</strong> Compute the confidence interval for sigma</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"> <span class="kw">sigma</span>(model, <span class="dt">confidence =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt;    sigma      lwr      upr </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">#&gt; 1.611991 1.108674 1.996447</span></a></code></pre></div>
<h3>
Source of Package
</h3>
<h4>
Rcpp
</h4>
<p><br> The use of C++ library RcppArmadillo allows us to compute various matrix multiplication and decomposition to improve the speed of the function. This package include a blblm or blblm_par function which is in the use of fastlm function. In the use of linear algebra the function was able to compute coef, weight residual and sigma by matrix transformation and multiplication. When we calculation the coefficient and sigma, we accounted for weight generate from a multinomial distribution.</p>
<p>Rcpp fastlm function computes of the following estimates:<br> coefficient, residuals, rank, degree of freedom, sigma</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">//Rcpp function for weight linear regression</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="kw">using</span> <span class="kw">namespace</span> Rcpp;</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">List fastlm(<span class="at">const</span> arma::mat&amp; X, <span class="at">const</span> arma::colvec&amp; y, <span class="at">const</span> arma::vec&amp; wi) {</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">    <span class="dt">int</span> n = X.n_rows, k = X.n_cols, r = rank(X);</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">    </a>
<a class="sourceLine" id="cb12-11" data-line-number="11">    arma::mat weight = diagmat(wi); <span class="co">//get the weight vector</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">      </a>
<a class="sourceLine" id="cb12-13" data-line-number="13">    arma::colvec coef = arma::solve(((trans(X))*weight*X) , ((trans(X)*weight)*y));    </a>
<a class="sourceLine" id="cb12-14" data-line-number="14">    <span class="co">// fit model y ~ X</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15">    </a>
<a class="sourceLine" id="cb12-16" data-line-number="16">    arma::colvec res  = y - X*coef; <span class="co">// residuals</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">    </a>
<a class="sourceLine" id="cb12-18" data-line-number="18">    <span class="dt">double</span> weight_sum = accu(wi);</a>
<a class="sourceLine" id="cb12-19" data-line-number="19">    </a>
<a class="sourceLine" id="cb12-20" data-line-number="20">    <span class="dt">double</span> num = arma::as_scalar(( accu( weight * (pow(res,<span class="fl">2.0</span>)) ))); </a>
<a class="sourceLine" id="cb12-21" data-line-number="21">    <span class="dt">double</span> denom = weight_sum - r;</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">    <span class="dt">double</span> s =  sqrt(num / denom);</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">                                                        </a>
<a class="sourceLine" id="cb12-24" data-line-number="24">    <span class="cf">return</span> List::create(Named(<span class="st">&quot;coefficients&quot;</span>) = coef,</a>
<a class="sourceLine" id="cb12-25" data-line-number="25">                        Named(<span class="st">&quot;weight sum&quot;</span>)   = weight_sum,</a>
<a class="sourceLine" id="cb12-26" data-line-number="26">                        Named(<span class="st">&quot;sigma&quot;</span>)         = s,</a>
<a class="sourceLine" id="cb12-27" data-line-number="27">                        Named(<span class="st">&quot;df.residual&quot;</span>)  = n - k,</a>
<a class="sourceLine" id="cb12-28" data-line-number="28">                        Named(<span class="st">&quot;rank&quot;</span>)         = r,</a>
<a class="sourceLine" id="cb12-29" data-line-number="29">                        Named(<span class="st">&quot;response&quot;</span>)     = y,</a>
<a class="sourceLine" id="cb12-30" data-line-number="30">                        Named(<span class="st">&quot;Res&quot;</span>)  = res,</a>
<a class="sourceLine" id="cb12-31" data-line-number="31">                        Named(<span class="st">&quot;weight&quot;</span>) = wi);</a>
<a class="sourceLine" id="cb12-32" data-line-number="32">}</a></code></pre></div>
<p>Compare the time of fastlm with weighted linear regression(lm.wif) and it is two times faster than the speed of weighted lm.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co">#transform the response and explanatory variable to fit the function</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">x &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(mpg <span class="op">~</span><span class="st"> </span>wt <span class="op">*</span><span class="st"> </span>hp , mtcars)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">y &lt;-<span class="st"> </span><span class="kw">model.response</span>(<span class="kw">model.frame</span>(mpg <span class="op">~</span><span class="st"> </span>wt <span class="op">*</span><span class="st"> </span>hp, mtcars))</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">w &lt;-<span class="st"> </span><span class="kw">rmultinom</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(mtcars)))</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#comapre three lm functions</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">bench<span class="op">::</span><span class="kw">mark</span>(</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">  <span class="dt">fastlm =</span> {<span class="kw">fastlm</span>(x,y,w)},</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">  <span class="dt">weighted_lm =</span> {<span class="kw">lm.wfit</span>(x,y,w)},</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">  <span class="dt">check =</span> <span class="ot">FALSE</span>, <span class="dt">relative =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt; # A tibble: 2 x 6</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt;   expression    min median `itr/sec` mem_alloc `gc/sec`</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt;   &lt;bch:expr&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt; 1 fastlm       1      1         2.00       1       1   </span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt; 2 weighted_lm  2.27   2.06      1         28.3     2.51</span></a></code></pre></div>
<h4>
Parallelization
</h4>
<p><br> The use of library(parallel) allows us to create the blblm_par function to include parallelizatoin for user to choose to work with cluster to speed up the process.</p>
<p>The use of library(parallel) allow this function to use parLapply in replacement of map to perform parallization.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co">#parallel function</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">blblm_par &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, m, B, cl) {</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  data_list &lt;-<span class="st"> </span>blblm<span class="op">:::</span><span class="kw">split_data</span>(data, m)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(data)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  estimates &lt;-<span class="st"> </span><span class="kw">parLapply</span>(cl, data_list, <span class="cf">function</span>(data, formula,n, B){</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">    blblm<span class="op">::</span><span class="kw">lm_each_subsample</span>(</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">      <span class="dt">formula =</span> formula, <span class="dt">data =</span> data , <span class="dt">n =</span> n, <span class="dt">B =</span> B)</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  }, <span class="dt">formula =</span> formula, <span class="dt">n =</span> n , <span class="dt">B =</span> B)</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  res &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">estimates =</span> estimates, <span class="dt">formula =</span> formula)</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  <span class="kw">class</span>(res) &lt;-<span class="st"> &quot;blblm&quot;</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  res</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">}</a></code></pre></div>
<p>The following demostrated the speed of using 2 CPU is almost two times faster than the orignial blblm. It may benefit users who want to process large datasets. It is typically practical for user who needs to process larger data set and use cluster to perform.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">bench<span class="op">::</span><span class="kw">mark</span>(</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="kw">blblm_par</span>(mpg <span class="op">~</span><span class="st"> </span>wt <span class="op">*</span><span class="st"> </span>hp, <span class="dt">data =</span> mtcars, <span class="dt">m =</span> <span class="dv">2</span>, <span class="dt">B =</span> <span class="dv">1000</span>, cl),</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  <span class="kw">blblm</span>(mpg <span class="op">~</span><span class="st"> </span>wt <span class="op">*</span><span class="st"> </span>hp, <span class="dt">data =</span> mtcars, <span class="dt">m =</span> <span class="dv">2</span>, <span class="dt">B =</span> <span class="dv">1000</span>),</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">  <span class="dt">check =</span> <span class="ot">FALSE</span>, <span class="dt">relative =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; # A tibble: 2 x 6</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt;   expression                                                     min median `itr/sec` mem_alloc</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt;   &lt;bch:expr&gt;                                                   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#&gt; 1 blblm_par(mpg ~ wt * hp, data = mtcars, m = 2, B = 1000, cl)  1      1         1.89        1 </span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt; 2 blblm(mpg ~ wt * hp, data = mtcars, m = 2, B = 1000)          1.89   1.89      1         190.</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co">#&gt; # … with 1 more variable: `gc/sec` &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="kw">stopCluster</span>(cl)</a></code></pre></div>
<p>Cited: Armadillo Library <a href="http://arma.sourceforge.net/" class="uri">http://arma.sourceforge.net/</a></p>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
